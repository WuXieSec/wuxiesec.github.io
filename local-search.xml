<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>应急响应（一）</title>
    <link href="/2022/08/26/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA1/"/>
    <url>/2022/08/26/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E9%9D%B6%E5%9C%BA1/</url>
    
    <content type="html"><![CDATA[<h1 id="应急响应靶场——-Win2008-WK木马"><a href="#应急响应靶场——-Win2008-WK木马" class="headerlink" title="应急响应靶场——(Win2008)WK木马"></a>应急响应靶场——(Win2008)WK木马</h1><h3 id="一、靶场出处"><a href="#一、靶场出处" class="headerlink" title="一、靶场出处"></a>一、靶场出处</h3><p>想要学习应急响应，然后就去找靶场，然后发现这位师傅有靶场环境，还有复现环境，故此学习一下。</p><ul><li><a href="https://wxiaoge.blog.csdn.net/?type=blog">https://wxiaoge.blog.csdn.net/?type=blog</a></li></ul><h3 id="二、靶场事件背景"><a href="#二、靶场事件背景" class="headerlink" title="二、靶场事件背景"></a>二、靶场事件背景</h3><ul><li><p>服务器疑似被入侵，风扇噪声很大</p></li><li><p>服务器为Windows2008，IP为192.168.226.137</p></li></ul><p><img src="/../images/yjxy-1/1.png"></p><h3 id="三、应急响应过程"><a href="#三、应急响应过程" class="headerlink" title="三、应急响应过程"></a>三、应急响应过程</h3><ul><li>一般情况下，CPU消耗很大的情况下风扇的噪声才会很大，应该是WK木马</li></ul><h4 id="3-1-排查服务器病毒程序"><a href="#3-1-排查服务器病毒程序" class="headerlink" title="3.1 排查服务器病毒程序"></a>3.1 排查服务器病毒程序</h4><h5 id="3-1-1、确认是否为WK"><a href="#3-1-1、确认是否为WK" class="headerlink" title="3.1.1、确认是否为WK"></a>3.1.1、确认是否为WK</h5><ul><li>发现服务器开了个java程序，上面带有一个外链网站</li></ul><p><img src="/../images/yjxy-1/2.png"></p><ul><li>微步在线 去查该外链URL，发现该URL为矿池</li></ul><p><img src="/../images/yjxy-1/3.png"></p><ul><li>通过查看任务管理器 发现该程序占用的 内存以及cpu使用率非常大</li></ul><p><img src="/../images/yjxy-1/4.png"></p><ul><li>右键打开该WK程序的位置，发现目录名字为wkxx<ul><li>C:\Users\Administrator\Downloads\wkbd\wkbd\javs.exe</li></ul></li></ul><p><img src="/../images/yjxy-1/5.png"></p><ul><li>通过查看config.json,发现Kuang池地址及其用户信息</li></ul><p><img src="/../images/yjxy-1/6.png"></p><ul><li>将java.exe上传到微步云沙箱，发现被标记为恶意软件</li></ul><p><img src="/../images/yjxy-1/7.png"></p><ul><li>确定是 WK程序了，在任务管理器结束掉，但是发现过一会儿该程序又运行了</li></ul><p><img src="/../images/yjxy-1/8.png"></p><p><img src="/../images/yjxy-1/9.png"></p><h5 id="3-1-2、深度排查服务器"><a href="#3-1-2、深度排查服务器" class="headerlink" title="3.1.2、深度排查服务器"></a>3.1.2、深度排查服务器</h5><ul><li>查看计划任务 taskschd.msc</li></ul><p><img src="/../images/yjxy-1/10.png"></p><ul><li>计划任务程序里面发现一个名称为system的计划任务是正在运行的</li></ul><p><img src="/../images/yjxy-1/11.png"></p><ul><li>点开该计划任务，查看操作发现是启动程序任务，并且启动程序的地址是指向WK程序的</li></ul><p><img src="/../images/yjxy-1/12.png"></p><ul><li>继续查看发现是Administrator用户在3月13号创建的计划任务</li></ul><p><img src="/../images/yjxy-1/13.png"></p><ul><li>删除该计划任务并任务管理器结束该进程和删除WK程序的目录</li></ul><p><img src="/../images/yjxy-1/14.png"></p><h4 id="3-2、排查服务器后门"><a href="#3-2、排查服务器后门" class="headerlink" title="3.2、排查服务器后门"></a>3.2、排查服务器后门</h4><h5 id="3-2-1、查看可疑进程"><a href="#3-2-1、查看可疑进程" class="headerlink" title="3.2.1、查看可疑进程"></a>3.2.1、查看可疑进程</h5><ul><li>使用利用Autoruns查看服务器是否有可疑进程<ul><li>未发现可疑进程</li></ul></li></ul><p><img src="/../images/yjxy-1/15.png"></p><h5 id="3-2-2、查看是否存在可疑的启动项"><a href="#3-2-2、查看是否存在可疑的启动项" class="headerlink" title="3.2.2、查看是否存在可疑的启动项"></a>3.2.2、查看是否存在可疑的启动项</h5><ul><li>用Autoruns查看是否有可疑的启动项<ul><li>未发现可疑的启动项</li></ul></li></ul><p><img src="/../images/yjxy-1/16.png"></p><h5 id="3-2-3、查看计划任务"><a href="#3-2-3、查看计划任务" class="headerlink" title="3.2.3、查看计划任务"></a>3.2.3、查看计划任务</h5><ul><li>查看计划任务，之前WK计划任务已经被删除，所以现在无异常的计划任务</li></ul><p><img src="/../images/yjxy-1/17.png"></p><h5 id="3-2-4、查看服务"><a href="#3-2-4、查看服务" class="headerlink" title="3.2.4、查看服务"></a>3.2.4、查看服务</h5><ul><li>未发现可疑的服务</li></ul><p><img src="/../images/yjxy-1/18.png"></p><h5 id="3-2-5、查看镜像劫持"><a href="#3-2-5、查看镜像劫持" class="headerlink" title="3.2.5、查看镜像劫持"></a>3.2.5、查看镜像劫持</h5><ul><li>发现shift粘贴键后门，后门路径C:\windows\system32\cmd.exe 可以在不登录服务器的情况下，以Administrator权限 执行cmd</li></ul><p><img src="/../images/yjxy-1/19.png"></p><h5 id="3-2-6、查看是否有隐藏用户"><a href="#3-2-6、查看是否有隐藏用户" class="headerlink" title="3.2.6、查看是否有隐藏用户"></a>3.2.6、查看是否有隐藏用户</h5><ul><li>通过 控制面板\所有控制面板项\用户帐户\管理帐户 里面只有administrator和guest用户</li></ul><p><img src="/../images/yjxy-1/20.png"></p><ul><li>通过注册表查看 HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\Names 发现wxiaoge$</li></ul><p><img src="/../images/yjxy-1/21.png"></p><h4 id="3-3、排查网络连接"><a href="#3-3、排查网络连接" class="headerlink" title="3.3、排查网络连接"></a>3.3、排查网络连接</h4><ul><li>使用netstat -ano 查看网络连接，未发现可疑连接</li></ul><p><img src="/../images/yjxy-1/22.png"></p><h4 id="四、应急响应溯源"><a href="#四、应急响应溯源" class="headerlink" title="四、应急响应溯源"></a>四、应急响应溯源</h4><h5 id="4-1-1、查看WK木马的计划任务创建时间"><a href="#4-1-1、查看WK木马的计划任务创建时间" class="headerlink" title="4.1.1、查看WK木马的计划任务创建时间"></a>4.1.1、查看WK木马的计划任务创建时间</h5><ul><li>WK木马的创建者是Administrator,创建时间是2022-03-23 9:46:17</li></ul><p><img src="/../images/yjxy-1/13.png"></p><h5 id="4-2-1-排查安全日志"><a href="#4-2-1-排查安全日志" class="headerlink" title="4.2.1 排查安全日志"></a>4.2.1 排查安全日志</h5><ul><li>分析安全日志 ，发现21号有大量的爆破</li></ul><p><img src="/../images/yjxy-1/25.png"></p><ul><li>但是均未发现ip地址</li></ul><p><img src="/../images/yjxy-1/26.png"></p><p><img src="/../images/yjxy-1/27.png"></p><ul><li>接着查找，发现2022&#x2F;3&#x2F;21 16:27:12，IP：192.168.226.1成功登录该服务器</li></ul><p><img src="/../images/yjxy-1/28.png"></p><ul><li>继续排查，发现在 2022&#x2F;3&#x2F;21 16:28:12 黑客使用administrator账户创建了隐藏账户 wxiaoge$</li></ul><p><img src="/../images/yjxy-1/29.png"></p><ul><li>继续排查系统日志，发现在 2022&#x2F;3&#x2F;23 9:36:02 服务器去解析 xmr.usa-138.com 域名，这个域名是公共矿池，说明此时已经植入挖矿程序并且运行</li></ul><p><img src="/../images/yjxy-1/30.png"></p><h4 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h4><h5 id="5-1-1、寻找WK小结"><a href="#5-1-1、寻找WK小结" class="headerlink" title="5.1.1、寻找WK小结"></a>5.1.1、寻找WK小结</h5><ul><li>1、WaKuang病毒位置：C:\Users\Administrator\Downloads\wkbd\wkbd\ 目录<ul><li>删除C:\Users\Administrator\Downloads\wkbd\wkbd\ 目录</li></ul></li><li>2、存在挖矿程序的计划任务，任务名字system<ul><li>删除挖矿程序的计划任务。</li></ul></li></ul><h5 id="5-1-2-排查小结"><a href="#5-1-2-排查小结" class="headerlink" title="5.1.2 排查小结"></a>5.1.2 排查小结</h5><ul><li><p>1、存在Windows隐藏用户</p><ul><li>通过注册表找到并删除</li></ul></li><li><p>2、存在shift粘贴键后门</p><ul><li>删除sethc.exe</li></ul></li></ul><h5 id="5-1-3溯源小结"><a href="#5-1-3溯源小结" class="headerlink" title="5.1.3溯源小结"></a>5.1.3溯源小结</h5><ul><li>根据日志推测：<ul><li>黑客在2022&#x2F;3&#x2F;21 16:27:12对服务器爆破administrarot成功，用ip为192.168.226.1登录成功</li><li>在2022&#x2F;3&#x2F;21 16:28:12使用administrator服务器创建了隐藏用户wxiaoge</li><li>在2022&#x2F;3&#x2F;23 9:36:02 植入挖矿程序并且运行</li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>应急</category>
      
    </categories>
    
    
    <tags>
      
      <tag>应急响应</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>红日靶场（一）（上）</title>
    <link href="/2022/08/26/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%911/"/>
    <url>/2022/08/26/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%911/</url>
    
    <content type="html"><![CDATA[<h1 id="红日内网靶场——红队评估-一-上"><a href="#红日内网靶场——红队评估-一-上" class="headerlink" title="红日内网靶场——红队评估(一)(上)"></a>红日内网靶场——红队评估(一)(上)</h1><h4 id="一、环境搭建"><a href="#一、环境搭建" class="headerlink" title="一、环境搭建"></a>一、环境搭建</h4><h5 id="1-1、环境部署"><a href="#1-1、环境部署" class="headerlink" title="1.1、环境部署"></a>1.1、环境部署</h5><ul><li>WIN7 （web服务器） 双网卡（内外网 IP）<ul><li>网卡 1 IP:192.168.52.143 （内网服务器 存在yxcms）</li><li>网卡 2 IP:192.168.17.130（外网DHCP自动获取）</li></ul></li><li>WIN 2008（域控） 单内网网卡<ul><li>网卡IP：192.168.52.138</li></ul></li><li>WIN 2003 （域成员） 单内网卡<ul><li>网卡IP ：192.168.52.141</li></ul></li><li>Kali （攻击机） 外网网卡<ul><li>网卡IP：192.168.17.131</li></ul></li></ul><h5 id="1-2、拓扑图"><a href="#1-2、拓扑图" class="headerlink" title="1.2、拓扑图"></a>1.2、拓扑图</h5><p><img src="/../images/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%91%201/1.png"></p><h4 id="二、信息收集"><a href="#二、信息收集" class="headerlink" title="二、信息收集"></a>二、信息收集</h4><h5 id="2-1、页面信息收集"><a href="#2-1、页面信息收集" class="headerlink" title="2.1、页面信息收集"></a>2.1、页面信息收集</h5><ul><li>192.168.17.130 打开是一个phpstudy的探针<ul><li>有一个数据库测试功能，尝试弱口令 root&#x2F;root，测试正常，说明数据库存在弱口令</li><li>发现了绝对路径和一些组件的版本信息，绝对路径可以sql注入写shell，版本信息可以找一些历史漏洞</li></ul></li></ul><p><img src="/../images/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%91%201/2.png"></p><p><img src="/../images/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%91%201/3.png"></p><h5 id="2-2、端口加敏感目录扫描"><a href="#2-2、端口加敏感目录扫描" class="headerlink" title="2.2、端口加敏感目录扫描"></a>2.2、端口加敏感目录扫描</h5><ul><li>使用nmap对192.168.17.130进行端口扫描 找找是否存在高危端口<ul><li>存在3306端口，是mysql的端口，刚才已经知道有弱口令了，一会儿可以直接利用。</li></ul></li></ul><p><img src="/../images/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%91%201/4.png"></p><ul><li>使用dirb扫描目录 探测是否存在敏感目录<ul><li>存在phpmyadmin，知道绝对路径，可以尝试写shell</li></ul></li></ul><p><img src="/../images/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%91%201/5.png"></p><ul><li>登陆phpmyadmin看看是否有可以利用的数据<ul><li>root&#x2F;root 弱口令登陆成功</li></ul></li></ul><p><img src="/../images/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%91%201/6.png"></p><ul><li>发现存在yxcms的数据库，尝试访问yxcms的路径。</li></ul><p><img src="/../images/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%91%201/8.png"></p><h5 id="2-3、yxcms的信息收集"><a href="#2-3、yxcms的信息收集" class="headerlink" title="2.3、yxcms的信息收集"></a>2.3、yxcms的信息收集</h5><ul><li>观察页面，发现公告上写着后台路径和 默认口令<ul><li>后台路径：&#x2F;index.php?r&#x3D;admin 默认口令：admin&#x2F;123456</li></ul></li></ul><p><img src="/../images/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%91%201/9.png"></p><ul><li>访问后台尝试默认密码登陆</li></ul><p><img src="/../images/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%91%201/10.png"></p><ul><li>登陆成功</li></ul><p><img src="/../images/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%91%201/11.png"></p><ul><li>通过观察后台页面，发现 有一个前台模版新建模版的功能点，可以直接写 php文件。</li></ul><p><img src="/../images/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%91%201/12.png"></p><p><img src="/../images/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%91%201/13.png"></p><h4 id="三、漏洞利用"><a href="#三、漏洞利用" class="headerlink" title="三、漏洞利用"></a>三、漏洞利用</h4><h5 id="3-1、利用phpmyadmin写shell"><a href="#3-1、利用phpmyadmin写shell" class="headerlink" title="3.1、利用phpmyadmin写shell"></a>3.1、利用phpmyadmin写shell</h5><ul><li>直接通过 SQL 查询语句 outfile 写入一句话木马，先看是否存在写入的权限<ul><li>show global variables like ‘%secure%’;<ul><li>显示为NULL 只可读不可写</li></ul></li></ul></li></ul><p><img src="/../images/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%91%201/14.png"></p><ul><li><p>开启全局日志getshell</p><ul><li>show variables like ‘%general%’;查询全局日志变量配置</li></ul></li></ul><p><img src="/../images/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%91%201/15.png"></p><ul><li>开启general_log将所有查询语句都记录到指定可以访问的文件中</li></ul><p><img src="/../images/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%91%201/16.png"></p><ul><li>日志记录的目录，是绝对路径，在php探针上已经拿到。</li></ul><p><img src="/../images/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%91%201/17.png"></p><ul><li>检查是否更改成功</li></ul><p><img src="/../images/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%91%201/17.png"></p><ul><li>尝试写入一句话木马. 就算报错日志也会记录下来。</li></ul><p><img src="/../images/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%91%201/18.png"></p><ul><li>尝试用哥斯拉连接  成功</li></ul><p><img src="/../images/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%91%201/19.png"></p><h5 id="3-2、yxcms上传webshell"><a href="#3-2、yxcms上传webshell" class="headerlink" title="3.2、yxcms上传webshell"></a>3.2、yxcms上传webshell</h5><ul><li>利用前台模版新建一个php页面，写上一句话木马，抓包看看是否有回显路径<ul><li>并没有返回URL的路径，只能试试别的办法</li></ul></li></ul><p><img src="/../images/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%91%201/20.png"></p><ul><li><p>没有路径 可以看看robots.txt 或者去做目录扫描，看看是否有新的发现</p><ul><li><p>访问robots.txt 看是否存在可利用的目录</p><ul><li>存在&#x2F;data &#x2F;protected目录 访问了一下 发现有个目录浏览，找到刚才传的she_ll.php</li></ul></li></ul></li></ul><p><img src="/../images/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%91%201/22.png"></p><p><img src="/../images/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%91%201/23.png"></p><pre><code class="hljs">- 路径http://192.168.17.130/yxcms//protected/apps/default/view/default/she_ll.php</code></pre><p><img src="/../images/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%91%201/25.png"></p><pre><code class="hljs">- 尝试连接</code></pre><p><img src="/../images/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%91%201/26.png"></p><p><img src="/../images/%E7%BA%A2%E6%97%A5%E5%86%85%E7%BD%91%201/27.png"></p>]]></content>
    
    
    <categories>
      
      <category>内网</category>
      
    </categories>
    
    
    <tags>
      
      <tag>内网学习</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
